# --- Imports ---
import pandas as pd
import numpy as np
import re
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.linear_model import LogisticRegression
from sklearn.svm import LinearSVC
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import joblib

# --- Load data ---
legitimate_urls = pd.read_csv('/kaggle/input/main-ds/legitimate.csv')
phishing_urls = pd.read_csv('/kaggle/input/main-ds/phishing.csv')

legitimate_urls['label'] = 0
phishing_urls['label'] = 1

data = pd.concat([legitimate_urls, phishing_urls], ignore_index=True)

# --- Preprocessing function ---
def preprocess_url(url):
    url = str(url).lower()
    url = re.sub(r'https?://', '', url)
    url = re.sub(r'www\.', '', url)
    url = re.sub(r'[^a-z0-9]', ' ', url)
    return url

processed_urls = data['url'].apply(preprocess_url)

# --- Preprocessing function ---
def preprocess_url(url):
    url = str(url).lower()
    url = re.sub(r'https?://', '', url)
    url = re.sub(r'www\.', '', url)
    url = re.sub(r'[^a-z0-9]', ' ', url)
    return url

processed_urls = data['url'].apply(preprocess_url)

# --- Vectorization ---
vectorizer = TfidfVectorizer()
X = vectorizer.fit_transform(processed_urls)
y = data['label']

# --- Train-test split ---
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# --- Random Forest ---
rf_model = RandomForestClassifier(random_state=42)
rf_model.fit(X_train, y_train)
rf_preds = rf_model.predict(X_test)

# --- Logistic Regression ---
lr_model = LogisticRegression(max_iter=1000)
lr_model.fit(X_train, y_train)
lr_preds = lr_model.predict(X_test)


# --- SVM (ADDED) ---
svm_model = LinearSVC(C=1.0, class_weight='balanced', max_iter=10000)
svm_model.fit(X_train, y_train)
svm_preds = svm_model.predict(X_test)

# --- Evaluation ---
print('Random Forest Accuracy:', accuracy_score(y_test, rf_preds))
print('Logistic Regression Accuracy:', accuracy_score(y_test, lr_preds))
print('SVM Accuracy:', accuracy_score(y_test, svm_preds))

print('\nSVM Classification Report:\n')
print(classification_report(y_test, svm_preds))

# --- Confusion Matrix for SVM ---
sns.heatmap(confusion_matrix(y_test, svm_preds), annot=True, fmt='d', cmap='Blues')
plt.title('SVM Confusion Matrix')
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.show()

# --- Test on new URLs ---
test_urls = [
    'https://www.google.com',
    'https://secure-login-paypal-account.com',
    'http://free-gift-card-amazon.verify-now.net'
]

test_processed = [preprocess_url(u) for u in test_urls]
test_features = vectorizer.transform(test_processed)

rf_test = rf_model.predict(test_features)
lr_test = lr_model.predict(test_features)
svm_test = svm_model.predict(test_features)

for i, url in enumerate(test_urls):
    print('URL:', url)
    print('RF:', 'Phishing' if rf_test[i] == 1 else 'Legitimate')
    print('LR:', 'Phishing' if lr_test[i] == 1 else 'Legitimate')
    print('SVM:', 'Phishing' if svm_test[i] == 1 else 'Legitimate')
    print('-' * 40)


# --- Save models ---
joblib.dump(vectorizer, 'tfidf_vectorizer.pkl')
joblib.dump(svm_model, 'svm_phishing_model.pkl')
joblib.dump(rf_model, 'rf_phishing_model.pkl')
joblib.dump(lf_model, 'lf_phishing_model.pkl')